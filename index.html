<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7">
    <title>ORDER SIMULATOR</title>
    <link rel="stylesheet" href="style.css">
    <script src="main.js" defer></script>
</head>
<body>

<div class="app-wrapper">
    <h2 class="main-title">ORDER SIMULATOR</h2>

    <div class="tab-container" id="tabContainer" data-active-tab="simulator">
        <div class="tab-active-bg"></div>
        <button id="tabBtn-simulator" class="tab-button active" data-tab="simulator">個別計算</button>
        <button id="tabBtn-all" class="tab-button" data-tab="all">一括確認</button>
        <button id="tabBtn-backup" class="tab-button" data-tab="backup">データ引継ぎ</button>
    </div>
    
    <div id="tab-simulator" class="tab-content active">
        <div class="card">
            <h3 class="section-title">システム設定</h3>
            <div class="form-group">
                <label><span>店舗名</span> <span id="saveIndicator" style="color: var(--success); font-size: 0.8rem;"></span></label>
                <input type="text" id="storeName" list="storeList" placeholder="店舗名を入力 (履歴から選択可能)">
                <datalist id="storeList"></datalist>
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <label>対象分類</label>
                <select id="categoryName">
                    <option value="" disabled selected>分類を選択してください</option>
                    <option value="おにぎり">おにぎり</option>
                    <option value="こだわりおにぎり">こだわりおにぎり</option>
                    <option value="弁当">弁当（常温・短鮮度）</option>
                    <option value="寿司">寿司</option>
                    <option value="チルド弁当">チルド弁当</option>
                    <option value="サンドイッチ">サンドイッチ</option>
                    <option value="ロール">ロール</option>
                    <option value="スパゲティパスタ">スパゲティパスタ</option>
                    <option value="グラタンドリア">グラタンドリア</option>
                    <option value="カップ麺">カップ麺</option>
                    <option value="調理麺">調理麺（冷たい麺）</option>
                    <option value="惣菜">惣菜</option>
                    <option value="カップデリ">カップデリ</option>
                    <option value="サラダ">サラダ</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-top: 16px; margin-bottom: 0;">
                <input type="text" id="freshnessDisplay" value="上の分類を選択してください" readonly tabindex="-1">
                <input type="hidden" id="freshnessTime" value="0">
            </div>
        </div>

        <div class="card">
            <h3 class="section-title">販売・在庫データ</h3>

            <details class="lecture-box">
                <summary>💡 ストアパソコン データ抽出手順</summary>
                <div class="lecture-content">
                    
                    <div class="step-group">
                        <div class="step-title">
                            <span>📊 販売データ・欠品率</span>
                            <span class="step-note">※毎月曜日に更新推奨</span>
                        </div>
                        <div class="step-flow">
                            <span>情報分析</span><div class="arrow">➔</div><span>機会損失状況</span><div class="arrow">➔</div><span>4週間一覧表(情報分類)</span>
                        </div>
                        <div class="step-desc">4週間平均の「販売数」「最高/最小販売数」、及びピーク時の「平均欠品率(%)」を抽出して入力します。</div>
                    </div>

                    <div class="step-group">
                        <div class="step-title"><span>📦 在庫データ</span></div>
                        <div class="step-flow">
                            <span>情報分析</span><div class="arrow">➔</div><span>期間損失状況</span><div class="arrow">➔</div><span>在庫推移表</span><div class="arrow">➔</div><span>PMA選択</span><div class="arrow">➔</div><span>情報分類選択</span><div class="arrow">➔</div><span>在庫推移表(単品)</span>
                        </div>
                        <div class="step-desc">発注時の在庫数を確認して入力します。</div>
                    </div>

                    <div class="step-group" style="margin-bottom: 0;">
                        <div class="step-title"><span>📅 曜日ごとの売上比率設定</span></div>
                        <div class="step-flow">
                            <span>4週間一覧表(情報分類)</span>
                        </div>
                        <div class="step-desc">4週間の平均販売の「曜日毎の販売数」から比率を算出して設定します。</div>
                    </div>

                </div>
            </details>

            <div class="flex-row">
                <div class="flex-col">
                    <label>平均販売数</label>
                    <input type="number" inputmode="numeric" id="avgSales" value="50" min="0">
                </div>
                <div class="flex-col">
                    <label>現在庫 (発注時)</label>
                    <input type="number" inputmode="numeric" id="currentStock" value="15" min="0">
                </div>
            </div>

            <div class="flex-row" style="align-items: center;">
                <div class="flex-col">
                    <label style="color: var(--primary);">最高販売数</label>
                    <input type="number" inputmode="numeric" id="maxSales" value="65" min="0">
                </div>
                <div style="font-weight: 800; color: #C7C7CC; margin-top: 15px;">ー</div>
                <div class="flex-col">
                    <label style="color: var(--primary);">最小販売数</label>
                    <input type="number" inputmode="numeric" id="minSales" value="35" min="0">
                </div>
            </div>
            
            <div class="info-box">
                <span style="font-size: 1.2rem;">💡</span>
                <div>
                    最大 <strong id="dispMax">65</strong> − 最小 <strong id="dispMin">35</strong> ＝ ブレ幅 <strong id="dispDiff">30</strong><br>
                    <span style="font-size: 0.85em; opacity: 0.8;">(標準偏差 <span id="dispStdDev">7.5</span> で安全在庫を自動最適化)</span>
                </div>
            </div>

            <div class="flex-row" style="margin-bottom: 0;">
                <div class="flex-col waste-input-box">
                    <label style="color: var(--danger);">平均廃棄数</label>
                    <input type="number" inputmode="numeric" id="avgWaste" value="3" min="0">
                </div>
                <div class="flex-col shortage-input-box">
                    <label style="color: #FF9500;">平均欠品率 (%)</label>
                    <input type="number" inputmode="numeric" id="avgShortageRate" value="0" min="0" max="100">
                </div>
            </div>

            <div class="flex-row display-input-box" id="displayInputArea" style="margin-top: 20px; margin-bottom: 0;">
                <div class="flex-col">
                    <label style="color: var(--primary);">最低陳列量</label>
                    <input type="number" inputmode="numeric" id="minDisplayQty" value="0" min="0">
                </div>
                <div class="flex-col"></div>
            </div>
        </div>

        <div class="card">
            <h3 class="section-title">外部変動要因</h3>
            <div class="form-group">
                <label>対象曜日</label>
                <select id="targetDay">
                    <option value="mon">月曜日</option>
                    <option value="tue">火曜日</option>
                    <option value="wed">水曜日</option>
                    <option value="thu">木曜日</option>
                    <option value="fri">金曜日</option>
                    <option value="sat">土曜日</option>
                    <option value="sun">日曜日</option>
                </select>
            </div>

            <div class="form-group">
                <label>曜日ごとの売上比率</label>
                <div class="day-ratio-container">
                    <div class="day-ratio-box"><label>月</label><select id="ratio_mon"></select></div>
                    <div class="day-ratio-box"><label>火</label><select id="ratio_tue"></select></div>
                    <div class="day-ratio-box"><label>水</label><select id="ratio_wed"></select></div>
                    <div class="day-ratio-box"><label>木</label><select id="ratio_thu"></select></div>
                    <div class="day-ratio-box"><label>金</label><select id="ratio_fri"></select></div>
                    <div class="day-ratio-box day-sat"><label>土</label><select id="ratio_sat"></select></div>
                    <div class="day-ratio-box day-sun"><label>日</label><select id="ratio_sun"></select></div>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 32px 0;">

            <div class="form-group weather-auto-area">
                <label class="weather-header">
                    <span>📍 気象庁データ 自動取得</span>
                    <span id="weatherStatus" style="font-size: 0.8rem; font-weight: normal; float: right;"></span>
                </label>
                
                <div class="flex-row" style="margin-bottom: 12px;">
                    <div class="flex-col">
                        <select id="prefecture" style="background-color: #fff;">
                            <option value="">-- 都道府県 --</option>
                            <option value="016000">北海道</option><option value="020000">青森県</option>
                            <option value="030000">岩手県</option><option value="040000">宮城県</option>
                            <option value="050000">秋田県</option><option value="060000">山形県</option>
                            <option value="070000">福島県</option><option value="080000">茨城県</option>
                            <option value="090000">栃木県</option><option value="100000">群馬県</option>
                            <option value="110000">埼玉県</option><option value="120000">千葉県</option>
                            <option value="130000">東京都</option><option value="140000">神奈川県</option>
                            <option value="150000">新潟県</option><option value="160000">富山県</option>
                            <option value="170000">石川県</option><option value="180000">福井県</option>
                            <option value="190000">山梨県</option><option value="200000">長野県</option>
                            <option value="210000">岐阜県</option><option value="220000">静岡県</option>
                            <option value="230000">愛知県</option><option value="240000">三重県</option>
                            <option value="250000">滋賀県</option><option value="260000">京都府</option>
                            <option value="270000">大阪府</option><option value="280000">兵庫県</option>
                            <option value="290000">奈良県</option><option value="300000">和歌山県</option>
                            <option value="310000">鳥取県</option><option value="320000">島根県</option>
                            <option value="330000">岡山県</option><option value="340000">広島県</option>
                            <option value="350000">山口県</option><option value="360000">徳島県</option>
                            <option value="370000">香川県</option><option value="380000">愛媛県</option>
                            <option value="390000">高知県</option><option value="400000">福岡県</option>
                            <option value="410000">佐賀県</option><option value="420000">長崎県</option>
                            <option value="430000">熊本県</option><option value="440000">大分県</option>
                            <option value="450000">宮崎県</option><option value="460100">鹿児島県</option>
                            <option value="471000">沖縄県</option>
                        </select>
                    </div>
                    <div class="flex-col">
                        <select id="cityArea" style="background-color: #fff;">
                            <option value="">-- エリア --</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 5px;">
                    <select id="targetDateOffset" style="background-color: #fff; color: #0369A1;">
                        <option value="1" id="opt-tomorrow">明日の予報を取得 (前日発注用)</option>
                        <option value="2" id="opt-dayafter">明後日の予報を取得 (前々日発注用)</option>
                    </select>
                </div>

                <div id="acquiredDateDisplay" class="acquired-weather-display">
                    <div class="awd-date">📅 対象日：<span id="acquiredDateText" style="color: #007AFF;"></span></div>
                    <div class="awd-weather">⛅ <span id="actualWeatherText"></span></div>
                </div>
            </div>

            <div class="flex-row">
                <div class="flex-col">
                    <label>天候補正</label>
                    <select id="weather">
                        <option value="1.2">イベント等 (1.2x)</option>
                        <option value="1.0">晴れ/曇/影響小 (1.0x)</option>
                        <option value="0.9">一時雨/小雨 (0.9x)</option>
                        <option value="0.8">本降りの雨/雪 (0.8x)</option>
                    </select>
                </div>
            </div>
            
            <div class="flex-row">
                <div class="flex-col">
                    <label style="color: var(--danger);">予想最高気温 (℃)</label>
                    <input type="number" inputmode="numeric" id="maxTemp" value="25">
                </div>
                <div class="flex-col">
                    <label style="color: var(--primary);">予想最低気温 (℃)</label>
                    <input type="number" inputmode="numeric" id="minTemp" value="15">
                </div>
            </div>
        </div>

        <button id="btn-calculate" class="calc-button">
            <span class="spinner"></span>
            <span id="btn-calc-text">⚡ AI 発注シミュレーション実行</span>
        </button>

        <div id="resultArea" class="result-card" style="display: none;">
            <h3 class="section-title">算出結果</h3>
            <div class="result-header">
                <strong id="resCategory"></strong> <span id="resFreshnessText" style="font-size:0.85rem; color:#8E8E93; font-weight:normal; margin-left:10px;"></span>
            </div>
            
            <div class="result-item" style="font-size: 0.85rem; margin-bottom: 10px;">
                (内訳: 基本 <span id="resBaseSales"></span> <span id="resShortageBoost" style="color:#FF9500; font-weight:bold;"></span> × 曜日 <span id="resDayRatio"></span> × 天候 <span id="resWeatherRatio"></span> × 気温 <span id="resTempRatio"></span>)
            </div>
            <div class="result-item" id="resTempMessage" style="color: #FFD60A; font-size: 0.95rem; margin-bottom: 24px; font-weight: 700;"></div>
            
            <div id="targetStockArea" style="display: none; margin-bottom: 24px;">
                <div class="result-item" style="color: #34C759; font-weight: 600; font-size: 1.05rem;">売場目標在庫数: <strong id="resTargetStock" style="font-size: 1.4rem;"></strong> 個</div>
                <div class="result-item" style="font-size: 0.85rem;" id="targetStockLabel"></div>
            </div>
            <div class="result-item" style="font-size: 0.95rem; color: #FF453A;"><span id="resMaxStockLabel"></span>: <strong id="resMaxStock"></strong></div>
            
            <div class="forecast-panel">
                <div style="font-size: 0.95rem; font-weight: bold; color: #5AC8FA;">📊 1日の販売予測</div>
                <div><span class="f-value" id="resAdjSales"></span> <span style="font-size: 1rem; color: #5AC8FA;">個</span></div>
            </div>

            <div class="order-panel">
                <div class="o-label">✅ 最終 発注目安数</div>
                <div><span class="o-value" id="resOrderQty"></span><span class="o-unit">個</span></div>
            </div>
            
            <div id="boostBreakdown" class="boost-breakdown">
                <div class="boost-row" style="color: #AEAEB2; font-size: 0.95rem;">
                    <span>通常算出:</span><span><strong id="resNormalQty" style="font-size: 1.2rem;"></strong> 個</span>
                </div>
                <div class="boost-row boost-highlight">
                    <span id="boostLabelText">🔥 気温ブースト:</span><span>+ <strong id="resBoostQty" style="font-size: 1.4rem;"></strong> 個</span>
                </div>
            </div>
        </div>
        
        <div id="warningArea" class="alert-box"><span id="warningMessageText"></span></div>
    </div>

    <div id="tab-all" class="tab-content">
        <div class="card">
            <h3 class="section-title">全分類 一括発注目安</h3>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5;">
                ※現在選択中の店舗（<strong id="allTabStoreName" style="color: var(--primary);">未選択</strong>）に保存されたデータと、現在の天候・曜日条件で一括計算しています。<br>
                <span style="font-size: 0.8rem; color: #8E8E93;">（項目をタップすると個別計算画面に移動します）</span>
            </p>
            
            <div id="allResultsContainer"></div>
            
            <button id="btn-refresh-all" class="calc-button" style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #34C759 0%, #28a745 100%);">
                <span class="spinner" id="allSpinner"></span>
                <span id="allBtnText">🔄 最新情報で一括更新</span>
            </button>
        </div>
    </div>

    <div id="tab-backup" class="tab-content">
        <div class="card" style="border: 2px dashed #C7C7CC; background: #fff;">
            <h3 class="section-title">💾 セーブデータ・引継ぎ</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px; line-height: 1.6;">
                入力したデータは自動保存されますが、端末を変更する際はこちらのコードを使用してください。
            </p>
            <textarea id="backupCode" class="backup-textarea" rows="5" placeholder="ここにバックアップコードが表示されます"></textarea>
            <div class="flex-row" style="margin-bottom: 0;">
                <button id="btn-export" class="backup-btn btn-create">コードを作成</button>
                <button id="btn-import" class="backup-btn btn-restore">貼付して復元</button>
            </div>
        </div>
    </div> 
</div>
</body>
</html>
